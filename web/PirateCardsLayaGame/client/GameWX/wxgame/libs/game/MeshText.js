var laya=function(){"use strict";var e;!function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}(e||(e={}));class t{static SetIndicesBuffer(e){for(var t=0,a=0;a<e.length;a+=6)t=a/3<<1,e[a+0]=e[a+3]=t,e[a+1]=e[a+5]=t+3,e[a+2]=t+1,e[a+4]=t+2}static SetVerticesSubBuffer(t,a=0,s,i,r,h,n,o){var l=r.length<<2;let T=0;switch(h){case e.Center:T=-(l>>3);break;case e.Left:T=0;break;case e.Right:T=-(l>>2)}let d=0,E=1;for(var p=0;p<l;p+=4){d=(p+1)%2;let e=r[p/4];var _=n.GetFrame(e,o);if(null!=_){var u=_.frameUV;E=u.r;var c=a+7*p;t[c+0]=T*s+i.x,t[c+1]=(d+1)*s+i.y,t[(c+=7)+0]=T*s+i.x,t[c+1]=d*s+i.y,T+=E,t[(c+=7)+0]=T*s+i.x,t[c+1]=(d+1)*s+i.y,t[(c+=7)+0]=T*s+i.x,t[c+1]=d*s+i.y;var m=a+7*p+3;t[m+0]=u.xMin,t[m+1]=u.yMin,t[(m+=7)+0]=u.xMin,t[m+1]=u.yMax,t[(m+=7)+0]=u.xMax,t[m+1]=u.yMin,t[(m+=7)+0]=u.xMax,t[m+1]=u.yMax}else console.warn("文字图集里没找到字符:"+e,"type="+o)}}static SetVerticesSubBufferTween(e,t=0,a,s){var i=s<<2;for(var r=0;r<i;r+=4){var h=t+7*r;e[h+0]+=a.x,e[h+1]+=a.y,e[(h+=7)+0]+=a.x,e[h+1]+=a.y,e[(h+=7)+0]+=a.x,e[h+1]+=a.y,e[(h+=7)+0]+=a.x,e[h+1]+=a.y}}static SetVerticesSubBufferTweenRate(e,t=0,a,s,i){var r=i<<2;for(var h=0;h<r;h+=4){var n=t+7*h+3+2;e[n+0]=a,e[(n+=7)+0]=a,e[(n+=7)+0]=a,e[(n+=7)+0]=a}}static PushGPUVertexBuffer(e){var t=e._vertexBuffer,a=t.getUint8Data();t.bind(),Laya.LayaGL.instance.bufferSubData(t._bufferType,0,a)}}window.ToolMeshText=t;var a=Laya.Vector3;class s{constructor(t,s,i,r){this.batchIndex=0,this.verticeBeginIndex=0,this.verticeEndIndex=0,this.hAlignType=e.Center,this.scale=.5,this._text="",this.textLength=0,this.position=new a,this.tweenRate=0,this.tweenSpeed=1,this.speedRandom=.2*Math.random()+.9,this.tweenValue=0,this.meshTextBatchMesh=t,this.batchIndex=s,this.verticeBeginIndex=i,this.verticeEndIndex=r,this.itemDefaultBuffer=t.verticesBuffer.slice(i,r)}get verticesBuffer(){return this.meshTextBatchMesh.mesh._vertexBuffer.getFloat32Data()}get atlas(){return this.meshTextBatchMesh.atlas}get Text(){return this._text}set Text(e){null==e&&(e=""),this.textLength=e.length,this._text=e,this.Reset(),t.SetVerticesSubBuffer(this.verticesBuffer,this.verticeBeginIndex,this.scale,this.position,this._text,this.hAlignType,this.atlas,this.atlaTypeKey),this.meshTextBatchMesh.isReshedMesh=!0}Reset(){this.tweenRate=0,this.verticesBuffer.set(this.itemDefaultBuffer,this.verticeBeginIndex),this.meshTextBatchMesh.isReshedMesh=!0}StartTween(){this.tweenRate=0,this.tweenValue=0,this.meshTextBatchMesh.AddTweenItem(this)}UpdateTween(e){this.tweenRate+=e*this.tweenSpeed*this.speedRandom,t.SetVerticesSubBufferTweenRate(this.verticesBuffer,this.verticeBeginIndex,this.tweenRate,0,this.textLength),this.meshTextBatchMesh.isReshedMesh=!0,this.tweenRate>=1&&this.OnTweenEnd()}OnTweenEnd(){this.meshTextBatchMesh.debugItemLoop?this.StartTween():this.RecoverPool()}RecoverPool(){this.Reset(),this.meshTextBatchMesh.RemoveTweenItem(this),this.meshTextBatchMesh.RecoverItem(this)}}var i=Laya.VertexMesh;class r{constructor(e,a=5,h=50){this.debugItemLoop=!1,this.uid=0,this.onceTextLength=10,this.maxTextNum=100,this.stringMaxLength=1e3,this.isReshedMesh=!1,this.useItemList=[],this.tweenItemList=[],this.uid=r.UID++,this.itemPoolKey="MeshTextItem__"+this.uid,this.atlas=e;var n=a*h;this.onceTextLength=a,this.maxTextNum=h,this.stringMaxLength=n;var o=7*(a<<2),l=7*(n<<2),T=3*(n<<1),d=i.getVertexDeclaration("POSITION,UV,UV1"),E=new Float32Array(l),p=new Uint16Array(T);t.SetIndicesBuffer(p);for(var _=0;_<n;_++)for(var u=0;u<4;u++){var c=4*_+u;E[c=7*c+6]=Math.random()}this.verticesBuffer=E,this.indicesBuffer=p,this.mesh=Laya.PrimitiveMesh._createMesh(d,E,p);for(_=h-1;_>=0;_--){var m=new s(this,_,_*o,(_+1)*o);Laya.Pool.recover(this.itemPoolKey,m)}}GetItem(e,t=new Laya.Vector3(0,0,0),a,s=1){var i=Laya.Pool.getItem(this.itemPoolKey);return null==i&&this.useItemList.length>0&&((i=this.useItemList.shift()).Reset(),this.RemoveTweenItem(i)),this.atlas.typeScaleMap.has(a)&&(s=this.atlas.typeScaleMap.get(a)),i.atlaTypeKey=a,i.position=t,i.scale=s,i.Text=e,this.useItemList.push(i),i}PlayItem(e,t=new Laya.Vector3(0,0,0),a,s=1,i=1){var r=this.GetItem(e,t,a,s);return r.tweenSpeed=i,r.StartTween(),r}RemoveUseFromList(e){var t=this.useItemList.indexOf(e);-1!=t&&this.useItemList.splice(t,1)}RecoverItem(e){Laya.Pool.recover(this.itemPoolKey,e),this.RemoveUseFromList(e)}AddTweenItem(e){-1==this.tweenItemList.indexOf(e)&&this.tweenItemList.push(e)}RemoveTweenItem(e){var t=this.tweenItemList.indexOf(e);-1!=t&&this.tweenItemList.splice(t,1)}StartUpdate(){Laya.timer.frameLoop(1,this,this.OnLoop)}StopUpdate(){Laya.timer.clear(this,this.OnLoop)}OnLoop(){this.isReshedMesh&&(t.PushGPUVertexBuffer(this.mesh),this.isReshedMesh=!1);for(var e=.001*Laya.timer.delta,a=this.tweenItemList.length-1;a>=0;a--){this.tweenItemList[a].UpdateTween(e)}}SetParent(e,t){this.__parent=e,this.__parentIndex=t}Show(){null!=this.__parentIndex?this.__parent.addChildAt(this.sprite,this.__parentIndex):this.__parent.addChild(this.sprite),this.StartUpdate()}Hide(){this.Clear(),this.sprite.removeSelf(),this.StopUpdate()}Clear(){for(;this.useItemList.length>0;){this.useItemList.shift().RecoverPool()}this.tweenItemList.length=0}}r.UID=0;class h extends Laya.MeshSprite3D{constructor(e,t){super(e.mesh,t),this.batchMesh=e,this.meshRenderer.bounds.setMin(new Laya.Vector3(-999999,-999999,-999999)),this.meshRenderer.bounds.setMax(new Laya.Vector3(999999,999999,999999))}}class n extends Laya.Material{static getShaderVS(e){return this.SHADER_PATH_ROOT+e+".vs"}static getShaderPS(e){return this.SHADER_PATH_ROOT+e+".fs"}static getShaderGLSL(e){return this.SHADER_PATH_ROOT+e+".glsl"}static async loadShaderGlslAsync(e){return(await this.loadAsync(this.getShaderGLSL(e),Laya.Loader.TEXT)).replace(/\r/g,"")}static async loadShaderVSAsync(e){return(await this.loadAsync(this.getShaderVS(e),Laya.Loader.TEXT)).replace(/\r/g,"")}static async loadShaderPSAsync(e){return(await this.loadAsync(this.getShaderPS(e),Laya.Loader.TEXT)).replace(/\r/g,"")}static async loadAsync(e,t){return new Promise(a=>{Laya.loader.load(e,Laya.Handler.create(null,e=>{a(e)}),null,t)})}}n.SHADER_PATH_ROOT="res/shaders/";var o=Laya.Shader3D,l=Laya.SubShader,T=Laya.VertexMesh,d=Laya.Vector4,E=Laya.RenderState,p=Laya.Material;class _ extends n{constructor(){super(),this._albedoColor=new d(1,1,1,1),this._albedoIntensity=1,this._enableVertexColor=!1,this._tweenPositionEnd=new d(.25,1,0,0),this.setShaderName(_.shaderName),this._shaderValues.setVector(_.ALBEDOCOLOR,new d(1,1,1,1)),this._shaderValues.setVector(_.TWEEN_POSITION_BEGIN,new d(0,0,0,0)),this._shaderValues.setVector(_.TWEEN_POSITION_END,this._tweenPositionEnd),this.renderMode=_.RENDERMODE_TRANSPARENT}static async install(){_._isInstalled||(_._isInstalled=!0,_.__initDefine__(),await _.initShader(),_.defaultMaterial=new _,_.defaultMaterial.lock=!0)}static async initShader(){var e,t,a,s,i,r=await _.loadShaderVSAsync(_.shaderName),h=await _.loadShaderPSAsync(_.shaderName);e={a_Position:T.MESH_POSITION0,a_Color:T.MESH_COLOR0,a_Texcoord0:T.MESH_TEXTURECOORDINATE0,a_Texcoord1:T.MESH_TEXTURECOORDINATE1,a_MvpMatrix:T.MESH_MVPMATRIX_ROW0},t={u_AlbedoTexture:o.PERIOD_MATERIAL,u_AlbedoColor:o.PERIOD_MATERIAL,u_TilingOffset:o.PERIOD_MATERIAL,u_AlphaTestValue:o.PERIOD_MATERIAL,u_TweenPositionBegin:o.PERIOD_MATERIAL,u_TweenPositionEnd:o.PERIOD_MATERIAL,u_MvpMatrix:o.PERIOD_SPRITE,u_FogStart:o.PERIOD_SCENE,u_FogRange:o.PERIOD_SCENE,u_FogColor:o.PERIOD_SCENE},a={s_Cull:o.RENDER_STATE_CULL,s_Blend:o.RENDER_STATE_BLEND,s_BlendSrc:o.RENDER_STATE_BLEND_SRC,s_BlendDst:o.RENDER_STATE_BLEND_DST,s_DepthTest:o.RENDER_STATE_DEPTH_TEST,s_DepthWrite:o.RENDER_STATE_DEPTH_WRITE},s=o.add(_.shaderName,null,null,!0),i=new l(e,t),s.addSubShader(i);i.addShaderPass(r,h,a)}static __initDefine__(){_.SHADERDEFINE_ALBEDOTEXTURE=o.getDefineByName("ALBEDOTEXTURE"),_.SHADERDEFINE_TILINGOFFSET=o.getDefineByName("TILINGOFFSET"),_.SHADERDEFINE_ENABLEVERTEXCOLOR=o.getDefineByName("ENABLEVERTEXCOLOR")}get albedoTexture(){return this._shaderValues.getTexture(_.ALBEDOTEXTURE)}set albedoTexture(e){e?this._shaderValues.addDefine(_.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(_.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(_.ALBEDOTEXTURE,e)}set renderMode(e){switch(e){case _.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=p.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=E.CULL_BACK,this.blend=E.BLEND_DISABLE,this.depthTest=E.DEPTHTEST_LESS;break;case _.RENDERMODE_CUTOUT:this.renderQueue=p.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=E.CULL_BACK,this.blend=E.BLEND_DISABLE,this.depthTest=E.DEPTHTEST_LESS;break;case _.RENDERMODE_TRANSPARENT:this.renderQueue=p.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=E.CULL_BACK,this.blend=E.BLEND_ENABLE_ALL,this.blendSrc=E.BLENDPARAM_SRC_ALPHA,this.blendDst=E.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=E.DEPTHTEST_LESS;break;default:throw new Error("MeshTextBatchTweenMaterial : renderMode value error.")}}get depthWrite(){return this._shaderValues.getBool(_.DEPTH_WRITE)}set depthWrite(e){this._shaderValues.setBool(_.DEPTH_WRITE,e)}get cull(){return this._shaderValues.getInt(_.CULL)}set cull(e){this._shaderValues.setInt(_.CULL,e)}get blend(){return this._shaderValues.getInt(_.BLEND)}set blend(e){this._shaderValues.setInt(_.BLEND,e)}get blendSrc(){return this._shaderValues.getInt(_.BLEND_SRC)}set blendSrc(e){this._shaderValues.setInt(_.BLEND_SRC,e)}get blendDst(){return this._shaderValues.getInt(_.BLEND_DST)}set blendDst(e){this._shaderValues.setInt(_.BLEND_DST,e)}get depthTest(){return this._shaderValues.getInt(_.DEPTH_TEST)}set depthTest(e){this._shaderValues.setInt(_.DEPTH_TEST,e)}get tweenPositionEnd(){return this._tweenPositionEnd}set tweenPositionEnd(e){this._tweenPositionEnd=e,this._shaderValues.setVector(_.TWEEN_POSITION_END,e)}clone(){var e=new _;return this.cloneTo(e),e._albedoIntensity=this._albedoIntensity,this._albedoColor.cloneTo(e._albedoColor),e}}_.shaderName="MeshTextBatchTween",_._isInstalled=!1,_.RENDERMODE_OPAQUE=0,_.RENDERMODE_CUTOUT=1,_.RENDERMODE_TRANSPARENT=2,_.RENDERMODE_ADDTIVE=3,_.ALBEDOTEXTURE=o.propertyNameToID("u_AlbedoTexture"),_.ALBEDOCOLOR=o.propertyNameToID("u_AlbedoColor"),_.TILINGOFFSET=o.propertyNameToID("u_TilingOffset"),_.TWEEN_POSITION_BEGIN=o.propertyNameToID("u_TweenPositionBegin"),_.TWEEN_POSITION_END=o.propertyNameToID("u_TweenPositionEnd"),_.CULL=o.propertyNameToID("s_Cull"),_.BLEND=o.propertyNameToID("s_Blend"),_.BLEND_SRC=o.propertyNameToID("s_BlendSrc"),_.BLEND_DST=o.propertyNameToID("s_BlendDst"),_.DEPTH_TEST=o.propertyNameToID("s_DepthTest"),_.DEPTH_WRITE=o.propertyNameToID("s_DepthWrite");var u,c,m=Laya.Shader3D,y=Laya.SubShader,L=Laya.VertexMesh,I=Laya.Vector4,R=Laya.RenderState,D=Laya.Material;class S extends n{constructor(){super(),this._albedoColor=new I(1,1,1,1),this._albedoIntensity=1,this._enableVertexColor=!1,this._tweenPositionEnd=new I(.5,2,0,0),this.setShaderName(S.shaderName),this._shaderValues.setVector(S.ALBEDOCOLOR,new I(1,1,1,1)),this._shaderValues.setVector(S.TWEEN_POSITION_BEGIN,new I(0,0,0,0)),this._shaderValues.setVector(S.TWEEN_POSITION_END,this._tweenPositionEnd),this.renderMode=S.RENDERMODE_TRANSPARENT}static async install(){S._isInstalled||(S._isInstalled=!0,S.__initDefine__(),await S.initShader(),S.defaultMaterial=new S,S.defaultMaterial.lock=!0)}static async initShader(){var e,t,a,s,i,r=await S.loadShaderVSAsync(S.shaderName),h=await S.loadShaderPSAsync("MeshTextBatchTween");e={a_Position:L.MESH_POSITION0,a_Color:L.MESH_COLOR0,a_Texcoord0:L.MESH_TEXTURECOORDINATE0,a_Texcoord1:L.MESH_TEXTURECOORDINATE1,a_MvpMatrix:L.MESH_MVPMATRIX_ROW0},t={u_AlbedoTexture:m.PERIOD_MATERIAL,u_AlbedoColor:m.PERIOD_MATERIAL,u_TilingOffset:m.PERIOD_MATERIAL,u_AlphaTestValue:m.PERIOD_MATERIAL,u_TweenPositionBegin:m.PERIOD_MATERIAL,u_TweenPositionEnd:m.PERIOD_MATERIAL,u_MvpMatrix:m.PERIOD_SPRITE,u_FogStart:m.PERIOD_SCENE,u_FogRange:m.PERIOD_SCENE,u_FogColor:m.PERIOD_SCENE},a={s_Cull:m.RENDER_STATE_CULL,s_Blend:m.RENDER_STATE_BLEND,s_BlendSrc:m.RENDER_STATE_BLEND_SRC,s_BlendDst:m.RENDER_STATE_BLEND_DST,s_DepthTest:m.RENDER_STATE_DEPTH_TEST,s_DepthWrite:m.RENDER_STATE_DEPTH_WRITE},s=m.add(S.shaderName,null,null,!0),i=new y(e,t),s.addSubShader(i);i.addShaderPass(r,h,a)}static __initDefine__(){S.SHADERDEFINE_ALBEDOTEXTURE=m.getDefineByName("ALBEDOTEXTURE"),S.SHADERDEFINE_TILINGOFFSET=m.getDefineByName("TILINGOFFSET"),S.SHADERDEFINE_ENABLEVERTEXCOLOR=m.getDefineByName("ENABLEVERTEXCOLOR")}get albedoTexture(){return this._shaderValues.getTexture(S.ALBEDOTEXTURE)}set albedoTexture(e){e?this._shaderValues.addDefine(S.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(S.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(S.ALBEDOTEXTURE,e)}set renderMode(e){switch(e){case S.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=D.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=R.CULL_BACK,this.blend=R.BLEND_DISABLE,this.depthTest=R.DEPTHTEST_LESS;break;case S.RENDERMODE_CUTOUT:this.renderQueue=D.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=R.CULL_BACK,this.blend=R.BLEND_DISABLE,this.depthTest=R.DEPTHTEST_LESS;break;case S.RENDERMODE_TRANSPARENT:this.renderQueue=D.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=R.CULL_BACK,this.blend=R.BLEND_ENABLE_ALL,this.blendSrc=R.BLENDPARAM_SRC_ALPHA,this.blendDst=R.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=R.DEPTHTEST_LESS;break;default:throw new Error("MeshTextBatchTweenSeparateMaterial : renderMode value error.")}}get depthWrite(){return this._shaderValues.getBool(S.DEPTH_WRITE)}set depthWrite(e){this._shaderValues.setBool(S.DEPTH_WRITE,e)}get cull(){return this._shaderValues.getInt(S.CULL)}set cull(e){this._shaderValues.setInt(S.CULL,e)}get blend(){return this._shaderValues.getInt(S.BLEND)}set blend(e){this._shaderValues.setInt(S.BLEND,e)}get blendSrc(){return this._shaderValues.getInt(S.BLEND_SRC)}set blendSrc(e){this._shaderValues.setInt(S.BLEND_SRC,e)}get blendDst(){return this._shaderValues.getInt(S.BLEND_DST)}set blendDst(e){this._shaderValues.setInt(S.BLEND_DST,e)}get depthTest(){return this._shaderValues.getInt(S.DEPTH_TEST)}set depthTest(e){this._shaderValues.setInt(S.DEPTH_TEST,e)}get tweenPositionEnd(){return this._tweenPositionEnd}set tweenPositionEnd(e){this._tweenPositionEnd=e,this._shaderValues.setVector(S.TWEEN_POSITION_END,e)}clone(){var e=new S;return this.cloneTo(e),e._albedoIntensity=this._albedoIntensity,this._albedoColor.cloneTo(e._albedoColor),e}}S.shaderName="MeshTextBatchTweenSeparate",S._isInstalled=!1,S.RENDERMODE_OPAQUE=0,S.RENDERMODE_CUTOUT=1,S.RENDERMODE_TRANSPARENT=2,S.RENDERMODE_ADDTIVE=3,S.ALBEDOTEXTURE=m.propertyNameToID("u_AlbedoTexture"),S.ALBEDOCOLOR=m.propertyNameToID("u_AlbedoColor"),S.TILINGOFFSET=m.propertyNameToID("u_TilingOffset"),S.TWEEN_POSITION_BEGIN=m.propertyNameToID("u_TweenPositionBegin"),S.TWEEN_POSITION_END=m.propertyNameToID("u_TweenPositionEnd"),S.CULL=m.propertyNameToID("s_Cull"),S.BLEND=m.propertyNameToID("s_Blend"),S.BLEND_SRC=m.propertyNameToID("s_BlendSrc"),S.BLEND_DST=m.propertyNameToID("s_BlendDst"),S.DEPTH_TEST=m.propertyNameToID("s_DepthTest"),S.DEPTH_WRITE=m.propertyNameToID("s_DepthWrite");class x{constructor(e,t){this.uid=0,this.typeMap=new Map,this.typeScaleMap=new Map,this.uid=x.UID++,this.texture=e,this.atlasData=t,this.InitUV()}get textureWidth(){return this.atlasData.meta.size.w}get textureHeight(){return this.atlasData.meta.size.h}get UnlitMaterial(){if(!this._UnlitMaterial){var e=new Laya.UnlitMaterial;e.renderMode=Laya.UnlitMaterial.RENDERMODE_TRANSPARENT,e.albedoTexture=this.texture,this._UnlitMaterial=e}return this._UnlitMaterial}get MeshTextBatchTweenMaterial(){if(!this._MeshTextBatchTweenMaterial){var e=new _;e.renderMode=Laya.UnlitMaterial.RENDERMODE_TRANSPARENT,e.albedoTexture=this.texture,this._MeshTextBatchTweenMaterial=e}return this._MeshTextBatchTweenMaterial}get MeshTextBatchTweenSeparateMaterial(){if(!this._MeshTextBatchTweenMaterial){var e=new S;e.renderMode=Laya.UnlitMaterial.RENDERMODE_TRANSPARENT,e.albedoTexture=this.texture,this._MeshTextBatchTweenSeparateMaterial=e}return this._MeshTextBatchTweenSeparateMaterial}static LoadAsync(e,t){return new Promise(a=>{Laya.loader.load(e,Laya.Handler.create(this,e=>{a(e)}),null,t)})}static Load3DAsync(e,t){return new Promise(a=>{Laya.loader.create(e,Laya.Handler.create(this,e=>{Laya.timer.frameOnce(1,this,()=>{a(e)})}),null,t)})}static async CreateAsync(e,t){var a=await this.LoadAsync(e,Laya.Loader.TEXTURE2D),s=await this.LoadAsync(t,Laya.Loader.JSON);return new x(a,s)}InitUV(){var e=this.atlasData,t=e.meta.size.w,a=e.meta.size.h;for(var s in e.frames){var i=e.frames[s];i.frameUV={xMin:i.frame.x/t,yMin:i.frame.y/a,xMax:(i.frame.x+i.frame.w)/t,yMax:(i.frame.y+i.frame.h)/a,r:i.frame.w/i.frame.h}}}GetType(e){return this.typeMap.get(e)}GetOrCreateType(e){return this.typeMap.has(e)||this.typeMap.set(e,new Map),this.typeMap.get(e)}GenerateNumType(e,t){void 0===t&&(t=e);for(var a=this.GetOrCreateType(t),s=0;s<=9;s++){var i=e+s;(h=this.atlasData.frames[i])?a.set(s.toString(),h):console.warn("文字图集里没找到字符:"+s+", type="+t+", frameName="+i)}for(var r of["-","+"]){var h;i=e+r;(h=this.atlasData.frames[i])&&a.set(s.toString(),h)}}AddToType(e,t,a){void 0===t&&(t=e);var s=this.GetOrCreateType(a),i=this.atlasData.frames[t];i&&s.set(e,i)}AddToAllType(e,t){void 0===t&&(t=e);var a=this.atlasData.frames[t];a&&this.typeMap.forEach((t,s)=>{t.set(e,a)})}GetTypeFrame(e,t){return this.GetType(t).get(e)}GetFrame(e,t){var a;return void 0!==t&&(a=this.GetTypeFrame(e,t))?a:a=this.atlasData.frames[e]}}x.UID=0,function(e){e.White="White_",e.Red="Red_",e.Green="Green_",e.WhiteBig="WhiteBig_",e.YellowBig="YellowBig_"}(u||(u={})),function(e){e[e.White=0]="White",e[e.Red=1]="Red",e[e.Green=2]="Green",e[e.WhiteBig=3]="WhiteBig",e[e.YellowBig=4]="YellowBig"}(c||(c={}));class w{constructor(){this.typeMap=new Map,this.chartsCache=new Map}GetType(e){return this.typeMap.get(e)}GetOrCreateType(e){return this.typeMap.has(e)||this.typeMap.set(e,new Map),this.typeMap.get(e)}GenerateNumType(e,t){for(var a=this.GetOrCreateType(t),s=0;s<=9;s++)a.set(s.toString(),e[s])}AddToAllType(e,t){void 0===t&&(t=e),this.typeMap.forEach((a,s)=>{a.set(e,t)})}AddToType(e,t,a){this.GetOrCreateType(a).set(e,t)}GetOrCreateCache(e){return this.chartsCache.has(e)||this.chartsCache.set(e,new Map),this.chartsCache.get(e)}GetCharts(e,t){var a=this.GetOrCreateCache(t);if(a.has(e))return a.get(e);if(t==this.defaultType)return e;for(var s=this.GetType(t),i="",r=0,h=e.length;r<h;r++){if(s.has(e[r]))i+=s.get(e[r]);else i+=e[r]}return a.set(e,i),i}}var f=Laya.Vector3,A=Laya.Tween;class M{constructor(e,t){this.index=0,this.scale=1,this._text="",this._text2="",this.position=new f,this.startX=0,this.startY=0,this.endY=0,this.tweenRate=0,this.tweenSpeed=1,this.speedRandom=.5*Math.random()+.7,this.tweenValue=0,this.bitmapText=e,this.index=t;var a=new Laya.Text;a.font=e.fontName,a.align="center",a.width=250,a.height=50,a.pivotX=.5*a.width,a.pivotY=.5*a.height,this.textTF=a}get Text(){return this._text}set Text(e){if(this._text!=e){null==e&&(e="");var t=e;this.bitmapText.textStyleMap&&(t=this.bitmapText.textStyleMap.GetCharts(e,this.atlaTypeKey)),this._text2!=t&&(this._text=e,this._text2=t,this.textTF.changeText(t))}}StartTween(){var e=this.textTF;this.tweenRate=0,this.tweenValue=0;let t=Number(Math.random().toFixed(2));this.startX=e.x=e.x-40+80*t,this.startY=e.y=e.y-80*t,this.endY=this.startY-80,e.scale(0,0),e.alpha=1,this.bitmapText.AddTweenItem(this)}UpdateTween(e){var t=this.tweenRate+=e*this.tweenSpeed;if(t<.17){var a=Mathf.Lerp(0,1.5,t/.17);this.textTF.scale(a,a)}else if(t<.34){a=Mathf.Lerp(1.5,.8,(t-.17)/.17);this.textTF.scale(a,a)}else t>.52&&(t=(t-.52)/.48,this.textTF.y=Mathf.Lerp(this.startY,this.endY,t),this.textTF.alpha=1-t);this.tweenRate>=1&&this.OnTweenEnd()}Clear(){A.clearAll(this.textTF),this.bitmapText.RemoveTweenItem(this)}OnTweenEnd(){if(A.clearAll(this.textTF),this.bitmapText.debugItemLoop)return this.textTF.pos(this.position.x,this.position.y),void this.StartTween();this.RecoverPool()}RecoverPool(){this.textTF.removeSelf(),A.clearAll(this.textTF),this.bitmapText.RemoveTweenItem(this),this.bitmapText.RecoverItem(this)}}var N,v=Laya.Text,g=Laya.BitmapFont,B=Laya.Handler;class O extends Laya.Sprite{constructor(){super(),this.debugItemLoop=!1,this.uid=0,this.fontName="WarFont",this.textItemCache=new Map,this.useItemList=[],this.tweenItemList=[],this.uid=O.UID++,this.itemPoolKey="WarBitmapTextItem__"+this.uid}LoadFont(e,t){var a=new g;this.bitmapFont=a,a.loadFont(e,new B(this,()=>{a.setSpaceWidth(10),v.registerBitmapFont(this.fontName,a),t&&t()}))}InitItemPool(e=100){for(var t=e-1;t>=0;t--){var a=new M(this,t);Laya.Pool.recover(this.itemPoolKey,a)}}GetItemCacheByType(e,t){var a;if(this.textItemCache.has(t)?a=this.textItemCache.get(t):(a=new Map,this.textItemCache.set(t,a)),a.has(e))return a.get(e);var s=[];return a.set(e,s),s}RecoverItemCache(e){this.GetItemCacheByType(e.Text,e.atlaTypeKey).push(e)}RemoveFromItemCache(e){if(e.atlaTypeKey){var t=this.GetItemCacheByType(e.Text,e.atlaTypeKey),a=t.indexOf(e);-1!=a&&t.splice(a,1)}}GetItemCache(e,t){var a=this.GetItemCacheByType(e,t);if(a.length>0){var s=a.shift(),i=Laya.Pool.getPoolBySign(this.itemPoolKey),r=i.indexOf(s);return-1!=r&&i.splice(r,1),s}return null}GetItem(e,t=new Laya.Vector3(0,0,0),a,s=1){var i=this.GetItemCache(e,a);return null==i&&(i=Laya.Pool.getItem(this.itemPoolKey))&&this.RemoveFromItemCache(i),null==i&&this.useItemList.length>0&&((i=this.useItemList.shift()).Clear(),this.RemoveFromItemCache(i)),i?(this.camera&&(this.camera.worldToViewportPoint(t,i.position),t=i.position),i.atlaTypeKey=a,i.position=t,i.textTF.pos(t.x,t.y),i.scale=s,i.Text=e,this.useItemList.push(i),i):null}PlayItem(e,t=new Laya.Vector3(0,0,0),a,s=1,i=1){var r=this.GetItem(e,t,a,s);return r?(r.tweenSpeed=i,this.addChild(r.textTF),r.StartTween(),r):null}RemoveUseFromList(e){var t=this.useItemList.indexOf(e);-1!=t&&this.useItemList.splice(t,1)}RecoverItem(e){this.RecoverItemCache(e),Laya.Pool.recover(this.itemPoolKey,e),this.RemoveUseFromList(e)}AddTweenItem(e){-1==this.tweenItemList.indexOf(e)&&this.tweenItemList.push(e)}RemoveTweenItem(e){var t=this.tweenItemList.indexOf(e);-1!=t&&this.tweenItemList.splice(t,1)}StartUpdate(){Laya.timer.frameLoop(1,this,this.OnLoop)}StopUpdate(){Laya.timer.clear(this,this.OnLoop)}OnLoop(){for(var e=.001*Laya.timer.delta,t=this.tweenItemList.length-1;t>=0;t--){this.tweenItemList[t].UpdateTween(e)}}SetParent(e,t){this.__parent=e,this.__parentIndex=t}Show(){null!=this.__parentIndex?this.__parent.addChildAt(this,this.__parentIndex):this.__parent.addChild(this),this.StartUpdate()}Hide(){this.Clear(),this.removeSelf(),this.StopUpdate()}Clear(){for(;this.useItemList.length>0;){this.useItemList.shift().RecoverPool()}this.tweenItemList.length=0}}O.UID=0,function(e){e[e.White=0]="White",e[e.Red=1]="Red",e[e.Green=2]="Green",e[e.WhiteBig=3]="WhiteBig",e[e.YelloBig=4]="YelloBig"}(N||(N={}));class P{static async LoadDefalutAsync(){if(!this.defaultAtlas){var e=this.defaultText=new O,t=this.defaultAtlas=new w;return this.defaultText.textStyleMap=t,t.GenerateNumType("012345679",N.White),t.GenerateNumType("qwertyuiop",N.Red),t.GenerateNumType("asdfghjkl;",N.Green),t.GenerateNumType("zxcvbnm,./",N.YelloBig),t.GenerateNumType("零一二三四五六七八九",N.WhiteBig),t.AddToAllType("d","闪"),t.AddToAllType("c","暴"),t.AddToType("c","爆",N.Red),new Promise(t=>{e.LoadFont("res/font/WarFont-export.fnt",()=>{e.InitItemPool(),t(e)})})}}}window.WarBitmapText=O,window.WarBitmapTextLib=P;class C{constructor(e,t){this.uid=0,this.typeMap=new Map,this.typeScaleMap=new Map,this.uid=C.UID++,this.texture=e,this.atlasData=t,this.InitUV()}get textureWidth(){return this.atlasData.meta.size.w}get textureHeight(){return this.atlasData.meta.size.h}static LoadAsync(e,t){return new Promise(a=>{Laya.loader.load(e,Laya.Handler.create(this,e=>{a(e)}),null,t)})}static Load3DAsync(e,t){return new Promise(a=>{Laya.loader.create(e,Laya.Handler.create(this,e=>{Laya.timer.frameOnce(1,this,()=>{a(e)})}),null,t)})}static LoadTexture(e){return new Promise(t=>{var a=new Laya.Texture;a.load(e,Laya.Handler.create(this,()=>{t(a)}))})}static async CreateAsync(e,t){var a=await this.LoadTexture(e),s=await this.LoadAsync(t,Laya.Loader.JSON);return new C(a,s)}InitUV(){var e=this.atlasData,t=e.meta.size.w,a=e.meta.size.h;for(var s in e.frames){var i=e.frames[s];i.frameUV={xMin:i.frame.x/t,yMin:i.frame.y/a,xMax:(i.frame.x+i.frame.w)/t,yMax:(i.frame.y+i.frame.h)/a,r:i.frame.w/i.frame.h};var r=i.frame;i.texture=Laya.Texture.createFromTexture(this.texture,r.x,r.y,r.w,r.h),i.poolSign="TextureTextAtlas_"+this.uid+"_"+s}}GetType(e){return this.typeMap.get(e)}GetOrCreateType(e){return this.typeMap.has(e)||this.typeMap.set(e,new Map),this.typeMap.get(e)}GenerateNumType(e,t){void 0===t&&(t=e);for(var a=this.GetOrCreateType(t),s=0;s<=9;s++){var i=e+s;(h=this.atlasData.frames[i])?a.set(s.toString(),h):console.warn("文字图集里没找到字符:"+s)}for(var r of["-","+"]){var h;i=e+r;(h=this.atlasData.frames[i])&&a.set(s.toString(),h)}}AddToType(e,t,a){void 0===t&&(t=e);var s=this.GetOrCreateType(a),i=this.atlasData.frames[t];i&&s.set(e,i)}AddToAllType(e,t){void 0===t&&(t=e);var a=this.atlasData.frames[t];a&&this.typeMap.forEach((t,s)=>{t.set(e,a)})}GetTypeFrame(e,t){return this.GetType(t).get(e)}GetFrame(e,t){var a;return void 0!==t&&(a=this.GetTypeFrame(e,t))?a:a=this.atlasData.frames[e]}InitAllChartSpritePool(e=100){var t=this.atlasData;for(var a in t.frames)for(var s=t.frames[a],i=0;i<e;i++){var r=this.CreateChartSprite(s);Laya.Pool.recover(s.poolSign,r)}}CreateChartSprite(e){var t=new Laya.Sprite;return t.texture=e.texture,t.width=e.frame.w,t.height=e.frame.h,t.name=e.poolSign,t}GetChartSprite(e,t){var a=this.GetFrame(e,t),s=Laya.Pool.getItem(a.poolSign);return s||(s=this.CreateChartSprite(a)),s}RecoverChartSprite(e){Laya.Pool.recover(e.name,e)}}C.UID=0;var U=Laya.Vector3,b=Laya.Tween;class V extends Laya.Sprite{constructor(e,t){super(),this.index=0,this._text="",this.spriteList=[],this.__scale=1,this.position=new U,this.startX=0,this.startY=0,this.endY=0,this.tweenRate=0,this.tweenSpeed=1,this.speedRandom=.5*Math.random()+.7,this.tweenValue=0,this.bitmapText=e,this.index=t}get Text(){return this._text}set Text(e){if(this._text!=e){for(var t of(null==e&&(e=""),this.spriteList))t.removeSelf(),this.bitmapText.textStyleMap.RecoverChartSprite(t);this.spriteList.length=0;for(var a=25*-e.length,s=0,i=e.length;s<i;s++){(t=this.bitmapText.textStyleMap.GetChartSprite(e[s],this.atlaTypeKey)).x=a,a+=t.width,this.addChild(t),this.spriteList.push(t)}this.pivotX=.5,this.pivotY=.5}}StartTween(){this.tweenRate=0,this.tweenValue=0;let e=Number(Math.random().toFixed(2));this.startX=this.x=this.x-40+80*e,this.startY=this.y=this.y-80*e,this.endY=this.startY-80,this.scale(0,0),this.alpha=1,this.bitmapText.AddTweenItem(this)}UpdateTween(e){var t=this.tweenRate+=e*this.tweenSpeed;if(t<.17){var a=Mathf.Lerp(0,1.5,t/.17);this.scale(a,a)}else if(t<.34){a=Mathf.Lerp(1.5,.8,(t-.17)/.17);this.scale(a,a)}else t>.52&&(t=(t-.52)/.48,this.y=Mathf.Lerp(this.startY,this.endY,t),this.alpha=1-t);this.tweenRate>=1&&this.OnTweenEnd()}Clear(){b.clearAll(this),this.bitmapText.RemoveTweenItem(this)}OnTweenEnd(){if(b.clearAll(this),this.bitmapText.debugItemLoop)return this.pos(this.position.x,this.position.y),void this.StartTween();this.RecoverPool()}RecoverPool(){this.removeSelf(),b.clearAll(this),this.bitmapText.RemoveTweenItem(this),this.bitmapText.RecoverItem(this)}}class G extends Laya.Sprite{constructor(e){super(),this.debugItemLoop=!1,this.uid=0,this.textItemCache=new Map,this.useItemList=[],this.tweenItemList=[],this.uid=G.UID++,this.itemPoolKey="WarTextureTextItem__"+this.uid,this.textStyleMap=e,this.InitItemPool()}InitItemPool(e=100){for(var t=e-1;t>=0;t--){var a=new V(this,t);Laya.Pool.recover(this.itemPoolKey,a)}}GetItemCacheByType(e,t){var a;if(this.textItemCache.has(t)?a=this.textItemCache.get(t):(a=new Map,this.textItemCache.set(t,a)),a.has(e))return a.get(e);var s=[];return a.set(e,s),s}RecoverItemCache(e){this.GetItemCacheByType(e.Text,e.atlaTypeKey).push(e)}RemoveFromItemCache(e){if(e.atlaTypeKey){var t=this.GetItemCacheByType(e.Text,e.atlaTypeKey),a=t.indexOf(e);-1!=a&&t.splice(a,1)}}GetItemCache(e,t){var a=this.GetItemCacheByType(e,t);if(a.length>0){var s=a.shift(),i=Laya.Pool.getPoolBySign(this.itemPoolKey),r=i.indexOf(s);return-1!=r&&i.splice(r,1),s}return null}GetItem(e,t=new Laya.Vector3(0,0,0),a,s=1){var i=this.GetItemCache(e,a);return null==i&&(i=Laya.Pool.getItem(this.itemPoolKey))&&this.RemoveFromItemCache(i),null==i&&this.useItemList.length>0&&((i=this.useItemList.shift()).Clear(),this.RemoveFromItemCache(i)),this.camera&&(this.camera.worldToViewportPoint(t,i.position),t=i.position),this.textStyleMap.typeScaleMap.has(a)&&(s=this.textStyleMap.typeScaleMap.get(a)),i.atlaTypeKey=a,i.position=t,i.pos(t.x,t.y),i.__scale=s,i.Text=e,this.useItemList.push(i),i}PlayItem(e,t=new Laya.Vector3(0,0,0),a,s=1,i=1){var r=this.GetItem(e,t,a,s);return r.tweenSpeed=i,this.addChild(r),r.StartTween(),r}RemoveUseFromList(e){var t=this.useItemList.indexOf(e);-1!=t&&this.useItemList.splice(t,1)}RecoverItem(e){this.RecoverItemCache(e),Laya.Pool.recover(this.itemPoolKey,e),this.RemoveUseFromList(e)}AddTweenItem(e){-1==this.tweenItemList.indexOf(e)&&this.tweenItemList.push(e)}RemoveTweenItem(e){var t=this.tweenItemList.indexOf(e);-1!=t&&this.tweenItemList.splice(t,1)}StartUpdate(){Laya.timer.frameLoop(1,this,this.OnLoop)}StopUpdate(){Laya.timer.clear(this,this.OnLoop)}OnLoop(){for(var e=.001*Laya.timer.delta,t=this.tweenItemList.length-1;t>=0;t--){this.tweenItemList[t].UpdateTween(e)}}SetParent(e,t){this.__parent=e,this.__parentIndex=t}Show(){null!=this.__parentIndex?this.__parent.addChildAt(this,this.__parentIndex):this.__parent.addChild(this),this.StartUpdate()}Hide(){this.Clear(),this.removeSelf(),this.StopUpdate()}Clear(){for(;this.useItemList.length>0;){this.useItemList.shift().RecoverPool()}this.tweenItemList.length=0}}G.UID=0;class W{static async LoadDefalutAsync(){if(!this.defaultAtlas){"res/font/WarMeshText.png","res/font/WarMeshText.txt";var e=await C.CreateAsync("res/font/WarMeshText.png","res/font/WarMeshText.txt");e.GenerateNumType(u.White,c.White),e.GenerateNumType(u.Red,c.Red),e.GenerateNumType(u.Green,c.Green),e.GenerateNumType(u.WhiteBig,c.WhiteBig),e.GenerateNumType(u.YellowBig,c.YellowBig),e.AddToAllType("c","c_yellow"),e.AddToType("c","c_red",c.Red),e.AddToAllType("d"),e.InitAllChartSpritePool(),this.defaultAtlas=e;var t=new G(e);this.defaultText=t}}}window.WarTextureText=G,window.WarTextureTextLib=W;class F{static async InitAsync(){this.isInited||(this.isInited=!0,await _.install(),await S.install())}static async LoadDefalutAsync(){if(await this.InitAsync(),!this.defaultAtlas){"res/font/WarMeshText.png","res/font/WarMeshText.txt";var e=await x.CreateAsync("res/font/WarMeshText.png","res/font/WarMeshText.txt");e.GenerateNumType(u.White,c.White),e.GenerateNumType(u.Red,c.Red),e.GenerateNumType(u.Green,c.Green),e.GenerateNumType(u.WhiteBig,c.WhiteBig),e.GenerateNumType(u.YellowBig,c.YellowBig),e.AddToAllType("c","c_yellow"),e.AddToType("c","c_red",c.Red),e.AddToAllType("d"),e.GenerateNumType(u.Red,c.Red),e.typeScaleMap.set(c.White,.2),e.typeScaleMap.set(c.Red,.2),e.typeScaleMap.set(c.Green,.2),e.typeScaleMap.set(c.WhiteBig,.3),e.typeScaleMap.set(c.YellowBig,.3);var t=new r(e),a=t.sprite=new h(t);a.meshRenderer.sharedMaterial=e.MeshTextBatchTweenMaterial,a.meshRenderer.sharedMaterial.renderQueue=Laya.BaseMaterial.RENDERQUEUE_TRANSPARENT+500,this.defaultAtlas=e,this.defaultText=t,this.defaultMeshTextBatchSprite=a}}}return F.isInited=!1,window.MeshTextBatchMesh=r,window.MeshTextBatchSprite=h,window.MeshTextAtlas=x,window.MeshTextType=u,window.TextStyleType=c,window.MeshTextBatchTweenMaterial=_,window.MeshTextBatchTweenSeparateMaterial=S,window.MeshTextLib=F,window.WarBitmapTextLib=P,window.WarTextureTextLib=W,F}();
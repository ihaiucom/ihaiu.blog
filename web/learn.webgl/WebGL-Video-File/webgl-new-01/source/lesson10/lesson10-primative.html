<html>
<head>
    <title>webgl-lesson5</title>
    <meta http-equiv="content-type" content="text/html; charset=gb2312">
    
    <script type ="text/javascript" src="glMatrix-0.9.6.min.js"></script>
    <script id="shader-vs">
        
        precision   lowp    float;
        attribute   vec3    v3Position;
        uniform     mat4    proj;
        void main(void)
        {
            gl_Position = proj * vec4(v3Position, 1.0);
        }
    </script>

    <script id="shader-fs">
        precision   lowp    float;
        uniform     vec4    color;
        void main(void)
        {
            gl_FragColor = color;
        }
    </script>

    <script>

        var webgl               =   null;
        var vertexShaderObject  =   null;
        var fragmentShaderObject=   null;
        var programObject       =   null;
        var triangleBuffer      =   null;
        var v3PositionIndex     =   0;
        var uniforColor         =   0;
        var uniformProj         =   0;

        var projectMat          =   mat4.create();


        function getShaderSource(scriptID) {
            var shaderScript = document.getElementById(scriptID);
            if (shaderScript == null) return "";

            var sourceCode = "";
            var child = shaderScript.firstChild;
            while (child) {
                if (child.nodeType == child.TEXT_NODE) sourceCode += child.textContent;
                child = child.nextSibling;
            }

            return sourceCode;
        }

        /**
        *   初始化,完成资源的加载.
        */
        function init() {

            var canvas = document.getElementById('myCanvas');
            webgl = canvas.getContext("webgl");

            webgl.viewport(0, 0, canvas.clientWidth, canvas.clientHeight);

            mat4.ortho(0,canvas.clientWidth,canvas.clientHeight,0,-1.0,1.0,projectMat);

            vertexShaderObject      =   webgl.createShader(webgl.VERTEX_SHADER);
            fragmentShaderObject    =   webgl.createShader(webgl.FRAGMENT_SHADER);

            webgl.shaderSource(vertexShaderObject,      getShaderSource("shader-vs"));
            webgl.shaderSource(fragmentShaderObject,    getShaderSource("shader-fs"));

            webgl.compileShader(vertexShaderObject);
            webgl.compileShader(fragmentShaderObject);

            if (!webgl.getShaderParameter(vertexShaderObject, webgl.COMPILE_STATUS)) 
            { 
                var err =   webgl.getShaderInfoLog(vertexShaderObject);
                alert(err);
                return; 
            }
            if (!webgl.getShaderParameter(fragmentShaderObject, webgl.COMPILE_STATUS))
            { 
                var err =   webgl.getShaderInfoLog(fragmentShaderObject);
                alert(err);
                return;
            }

            programObject = webgl.createProgram();

            webgl.attachShader(programObject, vertexShaderObject);
            webgl.attachShader(programObject, fragmentShaderObject);

            webgl.linkProgram(programObject);
            if (!webgl.getProgramParameter(programObject, webgl.LINK_STATUS)) 
            { 
                alert("error:programObject"); 
                return; 
            }

            webgl.useProgram(programObject);

            var jsArrayData = 
                [
                 
                    0,  100,    0,
                    0,  0,      0,
                    100,100,    0,
                    100,0,      0,
                    200,100,    0,
                    200,0,      0,

                ];

            var     circle  =   new Float32Array(362 * 3);
            var     radius  =   100;
            var     centerX =   200;
            var     centerY =   200;

            circle[0]   =  centerX; 
            circle[1]   =  centerY;
            circle[2]   =  0;

            for(var i = 1 ;i < 362 ; i ++ )
            {
                circle[i * 3 + 0]   =   radius * Math.cos(Math.PI/180 * i) + centerX;
                circle[i * 3 + 1]   =   radius * Math.sin(Math.PI/180 * i) + centerY;
                circle[i * 3 + 2]   =   0;
            }
           
            uniforColor     =   webgl.getUniformLocation(programObject,"color");
            uniformProj     =   webgl.getUniformLocation(programObject,"proj");
            webgl.bindAttribLocation(programObject, v3PositionIndex, "v3Position");

            webgl.uniform4f(uniforColor,0,1,0,1);

            triangleBuffer  =   webgl.createBuffer();
            webgl.bindBuffer(webgl.ARRAY_BUFFER, triangleBuffer);
            webgl.bufferData(webgl.ARRAY_BUFFER, circle, webgl.STATIC_DRAW);
            
        }

        function webGLStart() {
            //! 初始化
            init();
            //! 进入游戏循环
            tick();
        }

        function renderScene() {
    
            //! 设置重绘背景的颜色
            webgl.clearColor(0.0, 0.0, 0.0, 1.0);
            //! 执行绘制，即将背景清空成制定的颜色(clearColor)
            webgl.clear(webgl.COLOR_BUFFER_BIT);

            //! 指定绘制所使用的顶点数据 从 该缓冲区中获取
            webgl.bindBuffer(webgl.ARRAY_BUFFER, triangleBuffer);


            webgl.uniformMatrix4fv(uniformProj,false,projectMat);

            webgl.enableVertexAttribArray(v3PositionIndex);

            webgl.vertexAttribPointer(v3PositionIndex, 3, webgl.FLOAT, false, 4 * 3, 0);
            webgl.drawArrays(webgl.TRIANGLE_FAN,0,362);

            

        }


        function tick() {
            requestAnimFrame(tick);
            renderScene();
            
        }
        window.requestAnimFrame = (function() {
            return window.requestAnimationFrame ||
                   window.webkitRequestAnimationFrame ||
                   window.mozRequestAnimationFrame ||
                   window.oRequestAnimationFrame ||
                   window.msRequestAnimationFrame ||
                   function(callback, element) {
                       window.setTimeout(callback, 1000/60);
                   };
        })();

    </script>
</head>
<body onload='webGLStart()'>
    <canvas id="myCanvas" style="border: 1px solid red;" width='600' height='600'></canvas>
</body>
</html>

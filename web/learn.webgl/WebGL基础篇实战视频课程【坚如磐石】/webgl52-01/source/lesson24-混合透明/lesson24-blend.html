<html>
<head>
    <title>lesson24-blend</title>
    <meta http-equiv="content-type" content="text/html; charset=gb2312">
    
    <script type ="text/javascript" src="glMatrix-0.9.6.min.js"></script>
    <script id="shader-vs" type="x-shader/x-fragment">
        
        attribute vec3  position;
        attribute vec4  color;
        attribute vec2  textureCoord;
        uniform   mat4  mvpMatrix;
        uniform   float vertexAlpha;
        varying   vec4  vColor;
        varying   vec2  vTextureCoord;

        void main(void)
        {
	        vColor        = vec4(color.rgb, color.a * vertexAlpha);
	        vTextureCoord = textureCoord;
	        gl_Position   = mvpMatrix * vec4(position, 1.0);
        }
    </script>

    <script id="shader-fs" type="x-shader/x-fragment">

        precision mediump float;

        uniform sampler2D texture;
        uniform int       useTexture;
        varying vec4      vColor;
        varying vec2      vTextureCoord;

        void main(void)
        {
	        vec4 destColor = vec4(0.0);
	        if(bool(useTexture))
	        {
		        vec4 smpColor   =   texture2D(texture, vTextureCoord);
		        destColor       =   vColor * smpColor;
	        }
	        else
	        {
		        destColor   =   vColor;
	        }
	        gl_FragColor    =   destColor;
        }

    </script>

    <script>

        var webgl = null;
        var vertexShaderObject      = null;
        var fragmentShaderObject    = null;
        var programObject           = null;
        var attLocation             = new   Array();
        var uniLocation             = new   Array();
        var count   =   0;
        var canvas  =   null;
        function getShaderSource(scriptID) 
        {
            var shaderScript = document.getElementById(scriptID);
            if (shaderScript == null) return "";

            var sourceCode = "";
            var child = shaderScript.firstChild;
            while (child) 
            {
                if (child.nodeType == child.TEXT_NODE) sourceCode += child.textContent;
                child = child.nextSibling;
            }

            return sourceCode;
        }

        // VBO 生成
        function create_vbo(data)
        {
            var vbo = webgl.createBuffer();
            webgl.bindBuffer(webgl.ARRAY_BUFFER, vbo);
            webgl.bufferData(webgl.ARRAY_BUFFER, new Float32Array(data), webgl.STATIC_DRAW);
            webgl.bindBuffer(webgl.ARRAY_BUFFER, null);
            return vbo;
        }


        // Index Buffer Object 生成
        function create_ibo(data) 
        {
            var ibo = webgl.createBuffer();
            webgl.bindBuffer(webgl.ELEMENT_ARRAY_BUFFER, ibo);
            webgl.bufferData(webgl.ELEMENT_ARRAY_BUFFER, new Int16Array(data), webgl.STATIC_DRAW);
            webgl.bindBuffer(webgl.ELEMENT_ARRAY_BUFFER, null);
            return ibo;
        }
        /**
        *   初始化,完成资源的加载.
        */
        function init() 
        {

            canvas  =   document.getElementById('myCanvas');
            webgl   =   canvas.getContext("webgl");

            webgl.viewport(0, 0, canvas.clientWidth, canvas.clientHeight);
           

            vertexShaderObject      =   webgl.createShader(webgl.VERTEX_SHADER);
            fragmentShaderObject    =   webgl.createShader(webgl.FRAGMENT_SHADER);

            webgl.shaderSource(vertexShaderObject, getShaderSource("shader-vs"));
            webgl.shaderSource(fragmentShaderObject, getShaderSource("shader-fs"));

            webgl.compileShader(vertexShaderObject);
            webgl.compileShader(fragmentShaderObject);

            if (!webgl.getShaderParameter(vertexShaderObject, webgl.COMPILE_STATUS)) {
                var err = webgl.getShaderInfoLog(vertexShaderObject);
                alert(err);
                return;
            }
            if (!webgl.getShaderParameter(fragmentShaderObject, webgl.COMPILE_STATUS)) {
                var err = webgl.getShaderInfoLog(fragmentShaderObject);
                alert(err);
                return;
            }

            programObject = webgl.createProgram();

            webgl.attachShader(programObject, vertexShaderObject);
            webgl.attachShader(programObject, fragmentShaderObject);

            webgl.linkProgram(programObject);
            if (!webgl.getProgramParameter(programObject, webgl.LINK_STATUS)) {
                alert("error:programObject");
                return;
            }

            webgl.useProgram(programObject);

            attLocation[0] = webgl.getAttribLocation(programObject, 'position');
            attLocation[1] = webgl.getAttribLocation(programObject, 'color');
            attLocation[2] = webgl.getAttribLocation(programObject, 'textureCoord');

            
            uniLocation[0] = webgl.getUniformLocation(programObject, 'mvpMatrix');
            uniLocation[1] = webgl.getUniformLocation(programObject, 'vertexAlpha');
            uniLocation[2] = webgl.getUniformLocation(programObject, 'texture');
            uniLocation[3] = webgl.getUniformLocation(programObject, 'useTexture');


            webgl.enable(webgl.DEPTH_TEST);
            webgl.depthFunc(webgl.LEQUAL);

          
            var position = [
		                        -1.0, 1.0, 0.0,
		                         1.0, 1.0, 0.0,
		                        -1.0, -1.0, 0.0,
		                         1.0, -1.0, 0.0
	                        ];

            var color = [
		                    1.0, 0.0, 0.0, 1.0,
		                    0.0, 1.0, 0.0, 1.0,
		                    0.0, 0.0, 1.0, 1.0,
		                    1.0, 1.0, 1.0, 1.0
	                    ];

            var textureCoord = [
		                            0.0, 0.0,
		                            1.0, 0.0,
		                            0.0, 1.0,
		                            1.0, 1.0
	                            ];
            var index = [
		                    0, 1, 2,
		                    3, 2, 1
	                    ];
            textureHandle = initTexture("test.gif");
            // 创建定点缓冲区
            var vPosition       =   create_vbo(position);
            var vColor          =   create_vbo(color);
            var vTextureCoord   =   create_vbo(textureCoord);
            

            webgl.bindBuffer(webgl.ARRAY_BUFFER, vPosition);
            webgl.enableVertexAttribArray(attLocation[0]);
            webgl.vertexAttribPointer(attLocation[0], 3, webgl.FLOAT, false, 0, 0);


            webgl.bindBuffer(webgl.ARRAY_BUFFER, vColor);
            webgl.enableVertexAttribArray(attLocation[1]);
            webgl.vertexAttribPointer(attLocation[1], 4, webgl.FLOAT, false, 0, 0);

            webgl.bindBuffer(webgl.ARRAY_BUFFER, vTextureCoord);
            webgl.enableVertexAttribArray(attLocation[2]);
            webgl.vertexAttribPointer(attLocation[2], 2, webgl.FLOAT, false, 0, 0);


            var iIndex = create_ibo(index);
            webgl.bindBuffer(webgl.ELEMENT_ARRAY_BUFFER, iIndex);
        }

        function handleLoadedTexture(texture) 
        {
            webgl.bindTexture(webgl.TEXTURE_2D, texture);
            webgl.texImage2D(webgl.TEXTURE_2D, 0, webgl.RGBA, webgl.RGBA, webgl.UNSIGNED_BYTE, texture.image);
            webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_MAG_FILTER, webgl.LINEAR);
            webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_MIN_FILTER, webgl.LINEAR);
            webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_WRAP_S, webgl.CLAMP_TO_EDGE);
            webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_WRAP_T, webgl.CLAMP_TO_EDGE);

            webgl.bindTexture(webgl.TEXTURE_2D, null);
        }
        function initTexture(imageFile) 
        {
            var texture;
            //! 创建一个纹理 webgl
            texture = webgl.createTexture();
            //! 创建一个图片
            texture.image = new Image();
            //! 指定图片的路径
            texture.image.src = imageFile;
            texture.image.onload = function () {
                handleLoadedTexture(texture)
            }
            return texture;

        }


        var rPyramid = 0;
        var varTransZ = 0;
        var varTransX = 0;
        var varRot = 0;
        var varScale = 1;
        function handleKeyDown(event) {


            if (String.fromCharCode(event.keyCode) == 'W') {
                varTransZ -= 1;
            }
            else if (String.fromCharCode(event.keyCode) == 'S')
            {
                varTransZ += 1;
            }
            else if (String.fromCharCode(event.keyCode) == 'A') {
                varTransX -= 1;
            }
            else if (String.fromCharCode(event.keyCode) == 'D') {
                varTransX += 1;
            }
            else if (String.fromCharCode(event.keyCode) == 'R') {
                varRot += 1;
            }

            else if (String.fromCharCode(event.keyCode) == 'Z') {
                varScale += 0.1;
            }
            else if (String.fromCharCode(event.keyCode) == 'X') {
                varScale -= 0.1;
            }

        }

        function handleKeyUp(event) {
        }


        function webGLStart() {

            document.onkeydown  =   handleKeyDown;
            document.onkeyup    =   handleKeyUp;

            //! 初始化
            init();

            webgl.blendFunc(webgl.SRC_ALPHA, webgl.ONE);
            webgl.enable(webgl.BLEND);
          
            //! 进入游戏循环
            tick();
        }

        function degToRad(degrees) {
            return degrees * Math.PI / 180;
        }
        
        function renderScene() {

            //! 设置重绘背景的颜色
            webgl.clearColor(0.0, 0.0, 0.0, 1.0);
            webgl.clearDepth(1.0);
            //! 执行绘制，即将背景清空成制定的颜色(clearColor)
            webgl.clear(webgl.COLOR_BUFFER_BIT | webgl.DEPTH_BUFFER_BIT);
            webgl.enable(webgl.DEPTH_TEST);
           

            var     mMatrix     =   mat4.identity(mat4.create());
            var     vMatrix     =   mat4.identity(mat4.create());
            var     pMatrix     =   mat4.identity(mat4.create());
            var     tmpMatrix   =   mat4.identity(mat4.create());
            var     mvpMatrix   =   mat4.identity(mat4.create());

            count++;
            var rad = (count % 360) * Math.PI / 180;

            mat4.lookAt([0.0, 0.0, 5.0], [0, 0, 0], [0, 1, 0], vMatrix);
            mat4.perspective(45, canvas.clientWidth / canvas.clientHeight, 0.1, 100.0, pMatrix);

            mat4.multiply(pMatrix, vMatrix, tmpMatrix);
            
            mat4.identity(mMatrix);
            mat4.translate(mMatrix, [0.25, 0.25, -0.25], mMatrix);
            mat4.rotate(mMatrix, rad, [0, 1, 0], mMatrix);
            mat4.multiply(tmpMatrix, mMatrix, mvpMatrix);

            

            webgl.activeTexture(webgl.TEXTURE0);
            webgl.bindTexture(webgl.TEXTURE_2D, textureHandle);

            webgl.uniformMatrix4fv(uniLocation[0], false, mvpMatrix);
            webgl.uniform1f(uniLocation[1], 1.0);
            webgl.uniform1i(uniLocation[2], 0);
            webgl.uniform1i(uniLocation[3], true);
            webgl.drawElements(webgl.TRIANGLES, 6, webgl.UNSIGNED_SHORT, 0);

            mat4.identity(mMatrix);
            mat4.translate(mMatrix, [-0.25, -0.25, 0.25], mMatrix);
            mat4.rotate(mMatrix, rad, [0, 0, 1], mMatrix);
            mat4.multiply(tmpMatrix, mMatrix, mvpMatrix);

            webgl.bindTexture(webgl.TEXTURE_2D, null);

            webgl.enable(webgl.BLEND);

            webgl.uniformMatrix4fv(uniLocation[0], false, mvpMatrix);
            webgl.uniform1f(uniLocation[1], 0.5);
            webgl.uniform1i(uniLocation[2], 0);
            webgl.uniform1i(uniLocation[3], false);
            webgl.drawElements(webgl.TRIANGLES, 6, webgl.UNSIGNED_SHORT, 0);
        }


        function tick() 
        {
            requestAnimFrame(tick);
            renderScene();
        }

        window.requestAnimFrame = (function () {
            return window.requestAnimationFrame ||
                   window.webkitRequestAnimationFrame ||
                   window.mozRequestAnimationFrame ||
                   window.oRequestAnimationFrame ||
                   window.msRequestAnimationFrame ||
                   function (callback, element) {
                       window.setTimeout(callback, 1000 / 60);
                   };
        })();

    </script>
</head>
<body onload='webGLStart()'>
    <canvas id="myCanvas" style="border: 1px solid red;" width='600' height='600'></canvas>
</body>
</html>

---
layout: post
title: 网络同步
date: 2017-10-31 13:00:00
categories: 网络同步
tags: 网络同步 TRUESYNC ForgeNetworking
excerpt: 网络同步 TRUESYNC ForgeNetworking
shareexcerpt: 网络同步 TRUESYNC ForgeNetworking
thread: 20171031000000
author: 大海明月
authorQQ: 593705098
authorEmail: zengfeng75@qq.com
thumbnail: 

sh: true
sh_csharp: true
---





<br>
<br>
<h2 class="nav1">Photon TRUESYNC</h2>
<div class="" >
<ul>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.photonengine.com" draggable="false">
  <span class="title">Photon 官网首页(光子  专注多人网络同步游戏) </span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.photonengine.com/zh-TW/Realtime" draggable="false">
  <span class="title">Realtime 即时 (其实是让你去注册一个账号，然后创建应用。估计是使用它们的云服务平台。) </span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.photonengine.com/PUN" draggable="false">
  <span class="title">PUN （看着像Photon Unity Networking的缩写, 是Unity网络组建，主要是链接到https://www.assetstore.unity3d.com/en/#!/content/1786）</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.photonengine.com/PUN" draggable="false">
  <span class="title">Bolt （是 Steam 用的好像，主要是链接到https://www.assetstore.unity3d.com/en/#!/content/83233）</span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.photonengine.com/PUN" draggable="false">
  <span class="title">Thunder （Unity的UNET API的高级中继，打通和匹配服务，主要是链接到https://www.assetstore.unity3d.com/en/#!/content/83233）</span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.photonengine.com/PUN" draggable="false">
  <span class="title">TrueSync （TrueSync奠基在PUN的所有功能之上，更提供一个能够轻松实作高精度同步的架构与特制的物理引擎。，主要是链接到 https://www.assetstore.unity3d.com/en/#!/content/73228）</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.assetstore.unity3d.com/en/#!/content/1786" draggable="false">
  <span class="title">Photon Unity Networking Free, Unity网络组建 (assetstore)</span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.assetstore.unity3d.com/en/#!/content/83233" draggable="false">
  <span class="title">Photon Bolt $95.00, Steam使用的 (assetstore)</span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.assetstore.unity3d.com/en/#!/content/94901" draggable="false">
  <span class="title">Photon Thunder  Unity的UNET API的高级中继，打通和匹配服务(assetstore)</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://www.assetstore.unity3d.com/en/#!/content/94901" draggable="false">
  <span class="title">Photon TrueSync (assetstore)</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://doc.photonengine.com/en-us/realtime/current/getting-started/realtime-intro" draggable="false">
  <span class="title">Photon Documentation Realtime</span>
</a>
</li>

<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://doc.photonengine.com/en-us/pun/current/getting-started/pun-intro" draggable="false">
  <span class="title">Photon Documentation PUN</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://doc.photonengine.com/en-us/bolt/current/setup/overview" draggable="false">
  <span class="title">Photon Documentation Bolt</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://doc.photonengine.com/en-us/thunder/current/getting-started/introduction" draggable="false">
  <span class="title">Photon Documentation Thunder and UNet</span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://doc.photonengine.com/en-us/truesync/current/getting-started/truesync-intro" draggable="false">
  <span class="title">Photon Documentation TrueSync </span>
</a>
</li>



<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="http://forum.photonengine.com/" draggable="false">
  <span class="title">Photon forum 论坛 </span>
</a>
</li>


<li data-fid="1" data-index="1" draggable="true">
<a target="_blank" contextmenu="thumb-menu" href="https://mp.weixin.qq.com/s?__biz=MzU1NDI4NDIyNg==&mid=100000015&idx=1&sn=abc79b9fb757a296d363ffc60eaddb52&chksm=7be4a4a24c932db4516e070cb9a4a9422be00cbf3f5ef652cc91866af71625f84418805d0d8f&scene=18#rd" draggable="false">
  <span class="title">Photon产品介绍 </span>
</a>
</li>


</ul>
</div>


<br>
<br>
<h2 class="nav2">Photon IPunCallbacks 调用PhotonNetwork.ConnectUsingSettings(gameVersion);时的回调</h2>
<div class="" >
<pre>
OnPhotonCustomRoomPropertiesChanged
OnPhotonCustomRoomPropertiesChanged
OnCreatedRoom
OnJoinedRoom
</pre>
</div>

<br>
<br>
<h2 class="nav2">Photon IPunCallbacks 调用CreateRoom时的回调</h2>
<div class="" >
<pre>
OnConnectedToPhoton
OnConnectedToMaster
</pre>
</div>


<br>
<br>
<h2 class="nav2">Photon IPunCallbacks 调用JoinRandomRoom时的回调</h2>
<div class="" >
<pre>
OnPhotonRandomJoinFailed
</pre>
</div>


<br>
<br>
<h2 class="nav2">Photon IPunCallbacks 调用PhotonNetwork.LeaveRoom时的回调</h2>
<div class="" >
<pre>
OnLeftRoom
OnConnectedToMaster
</pre>
</div>


<br>
<br>
<h2 class="nav2">Photon IPunCallbacks 自己调用PhotonNetwork.LeaveRoom时的回调</h2>
<div class="" >
<pre>
OnLeftRoom
OnConnectedToMaster
</pre>
</div>


<br>
<br>
<h2 class="nav2">Photon IPunCallbacks 其他玩家调用PhotonNetwork.LeaveRoom时的回调</h2>
<div class="" >
<pre>
OnPhotonPlayerDisconnected(PhotonPlayer other)
</pre>
</div>


<br>
<br>
<h2 class="nav2">Photon IPunCallbacks 调用PhotonNetwork.LoadLevel;时的回调</h2>
<div class="" >
<pre>
OnLeftRoom
</pre>
</div>



<br>
<br>
<h2 class="nav2">TrueSync代码</h2>
<div class="" >
<ul>

<li>TrueSyncConfig</li>
<pre>
帧同步配置
</pre>

<li>TrueSyncManager</li>
<pre>
管理、驱动帧同步 
</pre>


<li>TrueSyncManager</li>
<pre>
管理、驱动帧同步 
</pre>

<li>TrueSyncBehaviour</li>
<pre>
帧同步行为，继承自 MonoBehaviour, 实现接口 ITrueSyncBehaviourGamePlay, ITrueSyncBehaviourCallbacks

// 该行为的拥有者玩家
public TSPlayerInfo owner;

// 本地玩家，相当于快捷访问本地玩家
public TSPlayerInfo localOwner;

// 快捷访问
TSTransform tsTransform
TSTransform2D tsTransform2D
TSRigidBody tsRigidBody
TSRigidBody2D tsRigidBody2D
TSCollider tsCollider
TSCollider2D tsCollider2D

// 基本上就是上面这些属性，实现的接口都是空的没有写业务逻辑

</pre>


<li>CoroutineScheduler</li>
<pre>
协程调用
在TrueSyncManager.SyncedStartCoroutine 调 StartCoroutine(IEnumerator coroutine) 启动一个协程
在TrueSyncManager驱动UpdateAllCorutines()
</pre>



<li>ITrueSyncBehaviour</li>
<pre>
接口 帧同步行为
就只有一个方法
// 设置游戏信息 (本地玩家， 玩家数量)
void SetGameInfo(TSPlayerInfo localOwner, int numberOfPlayers);
</pre>


<li>ITrueSyncBehaviourGamePlay</li>
<pre>
接口 玩家操作帧同步行为, 继承自ITrueSyncBehaviour

// 同步 玩家输入操作
void OnSyncedInput();



// 同步 读取玩家操作
void OnSyncedUpdate();

void OnPreSyncedUpdate();
</pre>


<li>ITrueSyncBehaviourCallbacks</li>
<pre>
接口 回调同步行为, 继承自ITrueSyncBehaviour

// 开始
void OnSyncedStart();



// 开始 -- 只调本地玩家的
void OnSyncedStartLocalPlayer();

// 游戏暂停
void OnGamePaused();

// 游戏继续
void OnGameUnPaused();

// 可以游戏了， 什么时候调用 我也不清楚
void OnGameEnded();


// 有玩家离线时调用
void OnPlayerDisconnection(int playerId);
</pre>





<li>TSRandom</li>
<pre>
随机数
http://www.codeproject.com/Articles/164087/Random-Number-Generation
https://github.com/ihaiucom/learn.PhotonTrueSync/blob/master/PhotonGame/Assets/TrueSync/Engine/Math/TSRandom.cs

原理是，传一个因素进去，然后里面生成N数量的数组。每个数有一个公式计算来生成。所以传相同的因素生成的结果是一样的。
获取随机数的时候根据当前索引mti依次读取数组里面的数。当mti大于N时，内部重新生成默认因素是5489U
</pre>

<p><a target="_blank" href="http://www.codeproject.com/Articles/164087/Random-Number-Generation">Random-Number-Generation </a></p>
<p><a target="_blank" href="https://github.com/ihaiucom/learn.PhotonTrueSync/blob/master/PhotonGame/Assets/TrueSync/Engine/Math/TSRandom.cs">TrueSync/Engine/Math/TSRandom.cs</a></p>



<li>StateTracker.TrackedInfo</li>
<pre>
状态跟踪信息， 用来保存对象引用，和对象的成员属性信息MemberInfo
object relatedObj； 保存对象
MemberInfo propInfo; 对象的成员属性信息
</pre>


<li>StateTracker.State</li>
<pre>
状态跟踪信息， 持有TrackedInfo跟踪信息

// 保存值到value变量
public void SaveValue()

// 将保存的值用反射赋值给对象
public void RestoreValue()
</pre>


<li>StateTracker</li>
<pre>
状态跟踪

//TSRandom 用到
StateTracker.AddTracking(r, "mt");
StateTracker.AddTracking(r, "mti");

//TrueSyncManager 用到
StateTracker.AddTracking(this, "time");


//TSTransform 用到 配合 [AddTracking] Attribute 使用, StateTracker.AddTracking(object obj)通过反射获取obj的成员变量
StateTracker.AddTracking(this);


// 这个是核心了， 里面保存了rollbackWindow数量的列表，AddTracking的时候回把StateTracker.State添加到所有列表里
// SaveState 的时候就保存GenericBufferWindow当前列表的, 保存完后就GenericBufferWindow的索引移动下一个
// RestoreState 从GenericBufferWindow当前的列表把值恢复
StateTracker.instance.states = new GenericBufferWindow<List<StateTracker.State>>(rollbackWindow);
</pre>



<li>ResourcePool 对象池</li>
<pre>
ResourcePool 是一个抽象对象池,他有一个静态对象池列表。他管理所有对象池的清理CleanUpAll();




ResourcePool<T> 是ResourcePool派生类。里面有一个对象栈存储空闲的对象。

// 还回对象
GiveBack(T obj)

// 获取对象, 如果T是ResourcePoolItem的派生类就会调对象的CleanUp()方法
T GetNew()

// 实例化对象
T NewInstance()



ResourcePoolItem 是对象池对象接口，实现该接口的对象在获取对象时会调CleanUp()方法




【使用】
internal class ResourcePoolListSyncedData : ResourcePool<List<SyncedData>>
internal class ResourcePoolStateTrackerState : ResourcePool<StateTracker.State>
internal class ResourcePoolSyncedData : ResourcePool<SyncedData>



</pre>



</ul>
</div>

